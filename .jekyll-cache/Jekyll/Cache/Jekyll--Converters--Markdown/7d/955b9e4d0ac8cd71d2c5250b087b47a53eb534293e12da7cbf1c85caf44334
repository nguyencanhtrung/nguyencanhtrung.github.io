I"Î*<h2 id="1-giá»›i-thiá»‡u">1. Giá»›i thiá»‡u</h2>

<p>VÃ o má»™t ngÃ y Ä‘áº¹p trá»i, má»™t ngÆ°á»i em Ä‘á»“ng nghiá»‡p cÅ© liÃªn há»‡ vá»›i tÃ´i vá»›i mong muá»‘n Ä‘Æ°á»£c truy cáº­p vÃ o card Xilinx Alveo AU200 Ä‘á»ƒ lÃ m project vá»›i <code class="language-plaintext highlighter-rouge">XDMA</code>, <code class="language-plaintext highlighter-rouge">QDMA</code>. VÃ¬ mÃ¡y cá»§a tÃ´i cÃ³ nhiá»u tÃ i liá»‡u cÃ¡ nhÃ¢n nÃªn khÃ´ng thá»ƒ cho truy cáº­p trá»±c tiáº¿p vÃ o mÃ¡y váº­t lÃ½ Ä‘Æ°á»£c. Sau má»™t lÃºc tÃ¬m hiá»ƒu, tÃ´i quyáº¿t Ä‘á»‹nh cÃ i Ä‘áº·t má»™t mÃ¡y áº£o (VM) vÃ  cho card PCIe passthrough vÃ o mÃ¡y áº£o nÃ y. Khi Ä‘Ã³, em áº¥y cÃ³ thá»ƒ cÃ i Ä‘áº·t driver trá»±c tiáº¿p trÃªn mÃ¡y áº£o, program FPGA thÃ´ng qua hardware client káº¿t ná»‘i vá»›i hardware server cÃ i Ä‘áº·t trÃªn mÃ¡y váº­t lÃ½.</p>

<p>Nhá»¯ng tÆ°á»Ÿng viá»‡c cÃ i Ä‘áº·t sáº½ máº¥t khoáº£ng 1 buá»•i chiá»u lÃ  xong, nhÆ°ng thá»±c táº¿ tÃ´i máº¥t hÆ¡n 2 ngÃ y (18h) Ä‘á»ƒ cÃ³ thá»ƒ cÃ i Ä‘áº·t xong. Series nÃ y sáº½ mÃ´ táº£ chi tiáº¿t cÃ¡c bÆ°á»›c tÃ´i Ä‘Ã£ tráº£i qua Ä‘á»ƒ hoÃ n thiá»‡n viá»‡c cÃ i Ä‘áº·t.</p>

<h2 id="2-cáº¥u-hÃ¬nh-vÃ -thÃ´ng-sá»‘-host">2. Cáº¥u hÃ¬nh vÃ  thÃ´ng sá»‘ host</h2>

<ul>
  <li>Mainboard: Z390 Gigabyte Aorus Wifi Pro</li>
  <li>CPU: Core i9 9900K</li>
  <li>RAM: 64GB DDR4</li>
  <li>SSD: 2TB</li>
  <li>OS: Ubuntu 20.04 - kernel: 5.15.06</li>
</ul>

<h2 id="3-mÃ¡y-áº£o-vm">3. MÃ¡y áº£o (VM)</h2>

<p>Giáº£i phÃ¡p mÃ  tÃ´i lá»±a chá»n cho viá»‡c áº£o hÃ³a lÃ  KVM. <strong>KVM (Kernel-based Virtual Machine)</strong> lÃ  má»™t cÃ´ng nghá»‡ áº£o hÃ³a dá»±a trÃªn kernel Linux, cho phÃ©p táº¡o vÃ  quáº£n lÃ½ mÃ¡y áº£o trÃªn má»™t há»‡ thá»‘ng Linux.</p>

<p>KVM Ä‘Æ°á»£c tÃ­ch há»£p trá»±c tiáº¿p vÃ o kernel Linux, Ä‘iá»u nÃ y Ä‘á»“ng nghÄ©a vá»›i viá»‡c nÃ³ sá»­ dá»¥ng nhá»¯ng lá»£i Ã­ch vÃ  tÃ­nh á»•n Ä‘á»‹nh cá»§a kernel Linux. NgoÃ i ra, viá»‡c nÃ³ Ä‘Æ°á»£c tÃ­ch há»£p vÃ o kernel Linux vÃ  sá»­ dá»¥ng trá»±c tiáº¿p tÃ i nguyÃªn pháº§n cá»©ng cá»§a há»‡ thá»‘ng, nÃªn nÃ³ cÃ³ hiá»‡u suáº¥t cao vÃ  Ä‘á»™ trá»… tháº¥p.</p>

<p><strong>KVM há»— trá»£ nhiá»u kiáº¿n trÃºc pháº§n cá»©ng (ISA)</strong> bao gá»“m x86, ARM vÃ  má»™t sá»‘ kiáº¿n trÃºc khÃ¡c. Äiá»u nÃ y lÃ m cho nÃ³ trá»Ÿ thÃ nh má»™t lá»±a chá»n linh hoáº¡t cho nhiá»u loáº¡i há»‡ thá»‘ng vÃ  á»©ng dá»¥ng.</p>

<p><strong>KVM há»— trá»£ há»‡ Ä‘iá»u hÃ nh Ä‘a dáº¡ng (Guest OS)</strong> bao gá»“m Linux, Windows, BSD, vÃ  nhiá»u distro Linux khÃ¡c nhau. Äiá»u nÃ y giÃºp cháº¡y cÃ¡c á»©ng dá»¥ng vÃ  mÃ¡y áº£o Ä‘a dáº¡ng trÃªn cÃ¹ng má»™t há»‡ thá»‘ng.</p>

<p><strong>KVM há»— trá»£ áº£o hÃ³a Ä‘áº§y Ä‘á»§</strong> bao gá»“m áº£o hÃ³a CPU vÃ  I/O. Äiá»u nÃ y cho phÃ©p cháº¡y cÃ¡c mÃ¡y áº£o cÃ³ hiá»‡u suáº¥t cao vÃ  sá»­ dá»¥ng Ä‘a dáº¡ng tÃ i nguyÃªn.</p>

<p><strong>Báº£o Máº­t:</strong> KVM Ä‘Æ°á»£c tÃ­ch há»£p sÃ¢u vÃ o kernel Linux, Ä‘iá»u nÃ y giÃºp cáº£i thiá»‡n báº£o máº­t báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c tÃ­nh nÄƒng báº£o máº­t cá»§a kernel.</p>

<p><strong>Quáº£n LÃ½ TÃ i NguyÃªn:</strong> KVM cÃ³ kháº£ nÄƒng quáº£n lÃ½ tÃ i nguyÃªn linh hoáº¡t, cho phÃ©p báº¡n cáº¥p phÃ¡t tÃ i nguyÃªn (CPU, RAM, á»• cá»©ng) cho cÃ¡c mÃ¡y áº£o má»™t cÃ¡ch tÃ¹y chá»‰nh.</p>

<p><strong>Há»— Trá»£ Cá»™ng Äá»“ng Máº¡nh Máº½:</strong> KVM Ä‘Æ°á»£c phÃ¡t triá»ƒn vÃ  duy trÃ¬ bá»Ÿi má»™t cá»™ng Ä‘á»“ng lá»›n cá»§a cÃ¡c nhÃ  phÃ¡t triá»ƒn vÃ  ngÆ°á»i dÃ¹ng. Äiá»u nÃ y Ä‘á»“ng nghÄ©a vá»›i viá»‡c cÃ³ nhiá»u tÃ i liá»‡u vÃ  há»— trá»£ trá»±c tuyáº¿n.</p>

<p><strong>Chi PhÃ­ Tháº¥p:</strong> KVM lÃ  mÃ£ nguá»“n má»Ÿ vÃ  miá»…n phÃ­, giÃºp giáº£m Ä‘i cÃ¡c chi phÃ­ liÃªn quan Ä‘áº¿n giáº¥y phÃ©p vÃ  pháº§n má»m.</p>

<p><strong>Kháº£ NÄƒng áº¢o HÃ³a GPU:</strong> KVM há»— trá»£ áº£o hÃ³a GPU, cho phÃ©p báº¡n cháº¡y á»©ng dá»¥ng Ä‘Ã²i há»i Ä‘á»“ há»a cao cáº¥p trong mÃ¡y áº£o.</p>

<p><strong>Máº¡nh Máº½ Cho áº¢o HÃ³a ÄÃ¡m MÃ¢y:</strong> KVM thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c mÃ´ hÃ¬nh áº£o hÃ³a Ä‘Ã¡m mÃ¢y vá»›i cÃ¡c cÃ´ng cá»¥ quáº£n lÃ½ nhÆ° OpenStack.</p>

<p>HÆ°á»›ng dáº«n cÃ i Ä‘áº·t mÃ¡y áº£o sáº½ Ä‘Æ°á»£c mÃ´ táº£ ká»¹ á»Ÿ pháº§n 2 cá»§a series.</p>

<h2 id="4-vfio">4. VFIO</h2>

<p>Äá»ƒ mÃ¡y áº£o (KVM) cÃ³ thá»ƒ truy cáº­p trá»±c tiáº¿p Ä‘Æ°á»£c vÃ o card PCIe, card Ä‘Ã³ pháº£i Ä‘Æ°á»£c áº£o hÃ³a. Pháº§n nÃ y giá»›i thiá»‡u framework há»— trá»£ viá»‡c nÃ y.</p>

<p>VFIO (Virtual Function I/O) lÃ  má»™t framework trong há»‡ thá»‘ng Linux cho phÃ©p áº£o hÃ³a cÃ¡c thiáº¿t bá»‹ I/O (Input-Output) nhÆ° card Ä‘á»“ há»a, card máº¡ng, hoáº·c cÃ¡c thiáº¿t bá»‹ PCIe khÃ¡c Ä‘á»ƒ chÃºng cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng trá»±c tiáº¿p bá»Ÿi cÃ¡c mÃ¡y áº£o. VFIO cho phÃ©p áº£o hÃ³a PCIe Passthrough, má»™t cÃ´ng nghá»‡ máº¡nh máº½ cho phÃ©p mÃ¡y áº£o truy cáº­p trá»±c tiáº¿p vÃ o thiáº¿t bá»‹ váº­t lÃ½, cáº£i thiá»‡n hiá»‡u suáº¥t vÃ  kháº£ nÄƒng sá»­ dá»¥ng cÃ¡c thiáº¿t bá»‹ Ä‘áº·c biá»‡t.</p>

<p>DÆ°á»›i Ä‘Ã¢y lÃ  má»™t sá»‘ Ä‘iá»ƒm quan trá»ng vá» VFIO:</p>

<p><strong>PCIe Passthrough:</strong> VFIO cho phÃ©p báº¡n cáº¥u hÃ¬nh mÃ¡y áº£o Ä‘á»ƒ truy cáº­p trá»±c tiáº¿p vÃ o má»™t thiáº¿t bá»‹ PCIe váº­t lÃ½, cháº³ng háº¡n nhÆ° card Ä‘á»“ há»a hoáº·c card máº¡ng. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  mÃ¡y áº£o cÃ³ thá»ƒ sá»­ dá»¥ng thiáº¿t bá»‹ nÃ y nhÆ° má»™t mÃ¡y tÃ­nh váº­t lÃ½ thay vÃ¬ thÃ´ng qua má»™t lá»›p trung gian.</p>

<p><strong>Hiá»‡u Suáº¥t Cao:</strong> PCIe Passthrough sá»­ dá»¥ng trá»±c tiáº¿p tÃ i nguyÃªn pháº§n cá»©ng vÃ  loáº¡i bá» Ä‘á»™ trá»… cá»§a mÃ¡y áº£o, giÃºp cáº£i thiá»‡n hiá»‡u suáº¥t, Ä‘áº·c biá»‡t lÃ  cho cÃ¡c á»©ng dá»¥ng Ä‘Ã²i há»i nhiá»u tÃ i nguyÃªn Ä‘á»“ há»a.</p>

<p><strong>Há»— Trá»£ áº¢o HÃ³a Äáº§y Äá»§:</strong> VFIO há»— trá»£ áº£o hÃ³a Ä‘áº§y Ä‘á»§, bao gá»“m áº£o hÃ³a CPU vÃ  I/O, Ä‘áº£m báº£o ráº±ng mÃ¡y áº£o cÃ³ thá»ƒ cháº¡y cÃ¡c há»‡ Ä‘iá»u hÃ nh khÃ¡ch Ä‘a dáº¡ng vÃ  sá»­ dá»¥ng tÃ i nguyÃªn má»™t cÃ¡ch hiá»‡u quáº£.</p>

<p><strong>Báº£o Máº­t:</strong> VFIO cung cáº¥p lá»›p báº£o máº­t cho cÃ¡c thiáº¿t bá»‹ Ä‘Æ°á»£c áº£o hÃ³a, ngÄƒn cháº·n viá»‡c truy cáº­p trÃ¡i phÃ©p tá»« mÃ¡y áº£o khÃ¡c hoáº·c tá»« há»‡ thá»‘ng mÃ¡y chá»§.</p>

<p><strong>áº¢o HÃ³a GPU:</strong> VFIO cho phÃ©p áº£o hÃ³a GPU, cho phÃ©p báº¡n cháº¡y cÃ¡c á»©ng dá»¥ng Ä‘Ã²i há»i Ä‘á»“ há»a cao cáº¥p trong mÃ¡y áº£o, cháº³ng háº¡n nhÆ° chÆ¡i game hoáº·c tÃ­nh toÃ¡n GPU.</p>

<p><strong>Cá»™ng Äá»“ng Há»— Trá»£:</strong> VFIO Ä‘Æ°á»£c há»— trá»£ bá»Ÿi má»™t cá»™ng Ä‘á»“ng Ä‘Ã´ng Ä‘áº£o vÃ  cÃ³ nhiá»u tÃ i liá»‡u, hÆ°á»›ng dáº«n vÃ  diá»…n Ä‘Ã n Ä‘á»ƒ giÃºp ngÆ°á»i dÃ¹ng cáº¥u hÃ¬nh vÃ  sá»­ dá»¥ng VFIO.</p>

<p>VFIO lÃ  má»™t cÃ´ng nghá»‡ quan trá»ng trong cÃ¡c mÃ´ hÃ¬nh áº£o hÃ³a Ä‘Ã²i há»i hiá»‡u suáº¥t cao vÃ  sá»­ dá»¥ng cÃ¡c thiáº¿t bá»‹ I/O Ä‘áº·c biá»‡t. NÃ³ giÃºp tá»‘i Æ°u hÃ³a tÃ i nguyÃªn vÃ  cáº£i thiá»‡n kháº£ nÄƒng sá»­ dá»¥ng cá»§a há»‡ thá»‘ng mÃ¡y chá»§ áº£o.</p>

<h2 id="5-iommu">5. IOMMU</h2>

<p>Äá»ƒ cÃ³ thá»ƒ passthrough PCIe thÃ nh cÃ´ng vÃ o mÃ¡y áº£o, chá»©c nÄƒng IOMMU pháº£i Ä‘Æ°á»£c <code class="language-plaintext highlighter-rouge">enable</code> á»Ÿ host. Pháº§n nÃ y giá»›i thiá»‡u tá»•ng quan vá» IOMMU.</p>

<p>IOMMU viáº¿t táº¯t cá»§a Input-Output Memory Management Unit. ÄÃ¢y lÃ  má»™t thÃ nh pháº§n pháº§n cá»©ng trong há»‡ thá»‘ng mÃ¡y tÃ­nh, thÆ°á»ng Ä‘Æ°á»£c tÃ­ch há»£p vÃ o chipset hoáº·c CPU, Ä‘Ã³ng vai trÃ² quan trá»ng trong viá»‡c quáº£n lÃ½ viá»‡c Ä‘á»‹a chá»‰ bá»™ nhá»› vÃ  truyá»n dá»¯ liá»‡u giá»¯a CPU vÃ  cÃ¡c thiáº¿t bá»‹ ngoáº¡i vi, bao gá»“m cÃ¡c thiáº¿t bá»‹ káº¿t ná»‘i qua PCIe (Peripheral Component Interconnect Express).</p>

<p>Táº¡i sao IOMMU láº¡i quan trá»ng:</p>

<p><strong>Dá»‹ch Äá»‹a Chá»‰ Bá»™ Nhá»›:</strong> Má»™t trong nhá»¯ng chá»©c nÄƒng chÃ­nh cá»§a IOMMU lÃ  dá»‹ch Ä‘á»‹a chá»‰ bá»™ nhá»› giá»¯a CPU vÃ  cÃ¡c thiáº¿t bá»‹ ngoáº¡i vi. Khi má»™t thiáº¿t bá»‹ muá»‘n Ä‘á»c hoáº·c ghi vÃ o bá»™ nhá»›, nÃ³ chá»‰ Ä‘á»‹nh má»™t Ä‘á»‹a chá»‰ bá»™ nhá»›. IOMMU dá»‹ch Ä‘á»‹a chá»‰ nÃ y Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng thiáº¿t bá»‹ cÃ³ thá»ƒ truy cáº­p vÃ o pháº§n bá»™ nhá»› há»‡ thá»‘ng chÃ­nh xÃ¡c. Sá»± dá»‹ch nÃ y quan trá»ng cho viá»‡c báº£o máº­t vÃ  báº£o vá»‡, vÃ¬ nÃ³ ngÄƒn cháº·n thiáº¿t bá»‹ truy cáº­p vÃ o cÃ¡c vá»‹ trÃ­ bá»™ nhá»› ngáº«u nhiÃªn.</p>

<p><strong>CÃ¡ch Ly Bá»™ Nhá»›:</strong> IOMMU cung cáº¥p cÃ¡ch ly bá»™ nhá»›, cÃ³ nghÄ©a lÃ  nÃ³ cÃ³ thá»ƒ cáº¥p phÃ¡t cÃ¡c vÃ¹ng cá»¥ thá»ƒ cá»§a bá»™ nhá»› Ä‘á»™c quyá»n cho cÃ¡c thiáº¿t bá»‹ hoáº·c mÃ¡y áº£o cá»¥ thá»ƒ. Äiá»u nÃ y Ä‘áº£m báº£o ráº±ng cÃ¡c thiáº¿t bá»‹ hoáº·c mÃ¡y áº£o khÃ´ng thá»ƒ truy cáº­p vÃ o bá»™ nhá»› bÃªn ngoÃ i cÃ¡c vÃ¹ng Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh cá»§a há», tÄƒng cÆ°á»ng báº£o máº­t vÃ  tÃ­nh á»•n Ä‘á»‹nh cá»§a há»‡ thá»‘ng.</p>

<p><strong>PCIe Passthrough:</strong> IOMMU lÃ  quan trá»ng cho cÃ´ng nghá»‡ PCIe passthrough, má»™t cÃ´ng nghá»‡ cho phÃ©p mÃ¡y áº£o truy cáº­p trá»±c tiáº¿p vÃ o má»™t thiáº¿t bá»‹ PCIe váº­t lÃ½, cháº³ng háº¡n nhÆ° card Ä‘á»“ há»a hoáº·c card máº¡ng. Náº¿u khÃ´ng cÃ³ sá»± há»— trá»£ cá»§a IOMMU, viá»‡c chia sáº» cÃ¡c thiáº¿t bá»‹ nÃ y an toÃ n vÃ  hiá»‡u quáº£ sáº½ trá»Ÿ nÃªn khÃ³ khÄƒn.</p>

<p><strong>áº¢o HÃ³a:</strong> Trong mÃ´i trÆ°á»ng áº£o hÃ³a, IOMMU cho phÃ©p Ã¡nh xáº¡ bá»™ nhá»› hiá»‡u quáº£ giá»¯a cÃ¡c mÃ¡y áº£o vÃ  pháº§n cá»©ng váº­t lÃ½. NÃ³ cho phÃ©p cÃ¡c mÃ¡y áº£o cÃ³ khÃ´ng gian Ä‘á»‹a chá»‰ bá»™ nhá»› riÃªng cá»§a há», giáº£m thiá»ƒu Ä‘á»™ trá»… vÃ  cáº£i thiá»‡n hiá»‡u suáº¥t.</p>

<p><strong>DMA (Direct Memory Access):</strong> CÃ¡c thiáº¿t bá»‹ nhÆ° GPU vÃ  card máº¡ng thÆ°á»ng sá»­ dá»¥ng DMA Ä‘á»ƒ truy cáº­p bá»™ nhá»› há»‡ thá»‘ng trá»±c tiáº¿p mÃ  khÃ´ng cáº§n sá»± can thiá»‡p cá»§a CPU. IOMMU Ä‘áº£m báº£o ráº±ng cÃ¡c hoáº¡t Ä‘á»™ng DMA Ä‘Æ°á»£c dá»‹ch vÃ  kiá»ƒm soÃ¡t Ä‘Ãºng cÃ¡ch, ngÄƒn cháº·n truy cáº­p báº¥t há»£p phÃ¡p vÃ o bá»™ nhá»›.</p>

<p><strong>Báº£o Máº­t:</strong> IOMMU tÄƒng cÆ°á»ng báº£o máº­t há»‡ thá»‘ng báº±ng cÃ¡ch ngÄƒn cháº·n cÃ¡c thiáº¿t bá»‹ hoáº·c pháº§n má»m Ä‘á»™c háº¡i truy cáº­p bá»™ nhá»› ngoÃ i cÃ¡c vÃ¹ng Ä‘Æ°á»£c á»§y quyá»n. NÃ³ giÃºp giáº£m thiá»ƒu má»™t sá»‘ loáº¡i táº¥n cÃ´ng dá»±a trÃªn can thiá»‡p vÃ o bá»™ nhá»›.</p>

<p><strong>Hiá»‡u NÄƒng:</strong> Máº·c dÃ¹ IOMMU thÃªm má»™t lá»›p dá»‹ch Ä‘á»‹a chá»‰, nÃ³ Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ thá»±c hiá»‡n Ä‘iá»u nÃ y má»™t cÃ¡ch hiá»‡u quáº£, giáº£m thiá»ƒu Ä‘á»™ trá»… hiá»‡u nÄƒng. Trong thá»±c táº¿, Ä‘á»‘i vá»›i má»™t sá»‘ táº£i cÃ´ng viá»‡c nhÆ° GPU passthrough cho viá»‡c chÆ¡i game trong mÃ¡y áº£o, sá»± há»— trá»£ cá»§a IOMMU cÃ³ thá»ƒ cáº£i thiá»‡n hiá»‡u suáº¥t báº±ng cÃ¡ch cung cáº¥p truy cáº­p trá»±c tiáº¿p vÃ o GPU.</p>

<p>TÃ³m láº¡i, IOMMU lÃ  má»™t thÃ nh pháº§n quan trá»ng Ä‘áº£m báº£o truyá»n dá»¯ liá»‡u an toÃ n vÃ  hiá»‡u quáº£ giá»¯a CPU vÃ  cÃ¡c thiáº¿t bá»‹ ngoáº¡i vi, Ä‘áº·c biá»‡t trong cÃ¡c tÃ¬nh huá»‘ng áº£o hÃ³a vÃ  PCIe passthrough. NÃ³ Ä‘Ã³ng má»™t vai trÃ² quan trá»ng trong quáº£n lÃ½ bá»™ nhá»›, báº£o máº­t vÃ  cÃ¡ch ly trong cÃ¡c há»‡ thá»‘ng mÃ¡y tÃ­nh hiá»‡n Ä‘áº¡i.</p>

<p>HÆ°á»›ng dáº«n vá» cÃ i Ä‘áº·t IOMMU Ä‘Æ°á»£c mÃ´ táº£ á»Ÿ pháº§n 3 cá»§a series.</p>
:ET
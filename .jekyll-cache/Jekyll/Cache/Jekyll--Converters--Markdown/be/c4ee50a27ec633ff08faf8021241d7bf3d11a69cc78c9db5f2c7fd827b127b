I"¶&<h2 id="1-introduction">1. Introduction</h2>

<p>Pipeline handshaking protocol giÃºp tá»‘i Æ°u throughout cá»§a há»‡ thá»‘ng. Tuy nhiÃªn, viá»‡c thiáº¿t káº¿ má»™t kiáº¿n trÃºc pipeline váº«n Ä‘áº£m báº£o Ä‘Æ°á»£c Ä‘áº·c tÃ­nh cá»§a handshaking protocol Ä‘Ã´i khi trá»Ÿ lÃªn phá»©c táº¡p quÃ¡ má»©c (Ã­t nháº¥t lÃ  Ä‘á»‘i vá»›i cÃ¡ nhÃ¢n tÃ´i trong thá»i gian Ä‘áº§u lÃ m viá»‡c vá»›i RTL design, tÃ´i Ä‘Ã£ thiáº¿t káº¿ má»™t Moore FSM gá»“m 8 states chá»‰ Ä‘á»ƒ xá»­ lÃ½ backpressure tá»« TREADY vÃ  cáº¯t Ä‘Æ°á»£c critical path tá»« tÃ­n hiá»‡u nÃ y). Blog nÃ y sáº½ mÃ´ táº£ má»™t cÃ¡ch chi tiáº¿t váº¥n Ä‘á» vÃ  cÃ¡ch giáº£i quyáº¿t.</p>

<h2 id="2-axis-protocol-vÃ -pipelining">2. AXIS protocol vÃ  pipelining</h2>

<h3 id="a-nguyÃªn-lÃ½-cá»§a-axis">a. NguyÃªn lÃ½ cá»§a AXIS</h3>

<p>Dáº¡ng Ä‘Æ¡n giáº£n nháº¥t cá»§a AXIS bao gá»“m 3 tÃ­n hiá»‡u <code class="language-plaintext highlighter-rouge">DATA</code> <code class="language-plaintext highlighter-rouge">VALID</code> vÃ  <code class="language-plaintext highlighter-rouge">READY</code>. Vá»›i thiáº¿t káº¿ <code class="language-plaintext highlighter-rouge">single cycle data transfer</code>, <code class="language-plaintext highlighter-rouge">DATA</code> Ä‘Æ°á»£c láº¥y máº«u vÃ  chuyá»ƒn tiáº¿p ra output thÃ nh cÃ´ng khi vÃ  chá»‰ khi:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">S_AXIS_TVALID = 1</code></li>
  <li>VÃ , <code class="language-plaintext highlighter-rouge">M_AXIS_TREADY = 1</code></li>
</ul>

<p>Táº¡i thá»i Ä‘iá»ƒm láº¥y máº«u cá»§a há»‡ thá»‘ng (sÆ°á»n lÃªn hoáº·c sÆ°á»n xuá»‘ng cá»§a clock)</p>

<p>Thiáº¿t káº¿ nÃ y sáº½ cÃ³ hai dáº¡ng thiáº¿t káº¿ nhÆ° á»Ÿ hÃ¬nh dÆ°á»›i:</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/3-480.webp" />
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/3-800.webp" />
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/3-1400.webp" />
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/01.blogs/230913_pipeline_axi_bus/3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" />

  </picture>

</figure>

    </div>
</div>

<p>Vá»›i thiáº¿t káº¿ bÃªn tay trÃ¡i, há»‡ thá»‘ng sáº½ chuyá»ƒn tiáº¿p dá»¯ liá»‡u tá»« <code class="language-plaintext highlighter-rouge">input</code> sang <code class="language-plaintext highlighter-rouge">output</code> khi vÃ  chá»‰ khi <code class="language-plaintext highlighter-rouge">consumer</code> táº¡i output sáºµn sÃ ng nháº­n dá»¯ liá»‡u. Vá»›i thiáº¿t káº¿ nÃ y <code class="language-plaintext highlighter-rouge">invalid</code> <code class="language-plaintext highlighter-rouge">input</code> cÅ©ng sáº½ Ä‘Æ°á»£c chuyá»ƒn tiáº¿p, trong má»™t pipeline, viá»‡c chuyá»ƒn tiáº¿p <code class="language-plaintext highlighter-rouge">invalid data</code> vÃ o trong pipe lÃ  hiá»‡n tÆ°á»£ng hÃ¬nh thÃ nh bubble.</p>

<p>Thiáº¿t káº¿ bÃªn tay pháº£i, giá»‘ng vá»›i thiáº¿t káº¿ tay trÃ¡i, tuy nhiÃªn nÃ³ Æ°u viá»‡t hÆ¡n do nÃ³ cÃ³ kháº£ nÄƒng loáº¡i bá» bubble trong pipeline. Viá»‡c loáº¡i bá» bubble xáº£y ra khi:</p>
<ul>
  <li>Bubble trong pipe Ä‘Æ°á»£c phÃ¡t hiá»‡n <code class="language-plaintext highlighter-rouge">m_axis_tvalid = '0'</code></li>
  <li>VÃ , <code class="language-plaintext highlighter-rouge">valid input</code> xuáº¥t hiá»‡n á»Ÿ Ä‘áº§u vÃ o <code class="language-plaintext highlighter-rouge">s_axis_tvalid = '1'</code></li>
</ul>

<p>Khi Ä‘Ã³ há»‡ thá»‘ng cho phÃ©p dá»¯ liá»‡u Ä‘Æ°á»£c chuyá»ƒn tiáº¿p dÃ¹ <code class="language-plaintext highlighter-rouge">consumer</code> váº«n chÆ°a sáºµn sÃ ng nháº­n dá»¯ liá»‡u. Bubble lÃºc nÃ y sáº½ Ä‘Æ°á»£c loáº¡i bá» báº±ng <code class="language-plaintext highlighter-rouge">valid</code> data.</p>

<p>Tuy nhiÃªn, hai thiáº¿t káº¿ trÃªn cÃ³ má»™t nhÆ°á»£c Ä‘iá»ƒm ráº¥t lá»›n Ä‘Ã³ lÃ  <code class="language-plaintext highlighter-rouge">critical path</code> sáº½ Ä‘Æ°á»£c hÃ¬nh thÃ nh trÃªn tÃ­n hiá»‡u <code class="language-plaintext highlighter-rouge">m_axis_tready</code> lÃ m giáº£m táº§n sá»‘ hoáº¡t Ä‘á»™ng cá»§a há»‡ thá»‘ng.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/5-480.webp" />
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/5-800.webp" />
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/5-1400.webp" />
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/01.blogs/230913_pipeline_axi_bus/5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" />

  </picture>

</figure>

    </div>
</div>

<h3 id="b-giáº£i-phÃ¡p-registering-tready">b. Giáº£i phÃ¡p registering <code class="language-plaintext highlighter-rouge">TREADY</code></h3>

<p>DÆ°á»›i Ä‘Ã¢y lÃ  má»™t phÆ°Æ¡ng phÃ¡p chÃ¨n <code class="language-plaintext highlighter-rouge">register</code> vÃ o Ä‘Æ°á»ng <code class="language-plaintext highlighter-rouge">TREADY</code>. <code class="language-plaintext highlighter-rouge">S_AXIS_TREADY</code> cháº­m hÆ¡n <code class="language-plaintext highlighter-rouge">M_AXIS_TREADY</code> 1 chu ká»³ clock, do Ä‘Ã³ ngay táº¡i chu ká»³ <code class="language-plaintext highlighter-rouge">M_AXIS_TREADY = '0'</code>, dá»¯ liá»‡u Ä‘ang cÃ³ á»Ÿ register sáº½ khÃ´ng Ä‘Æ°á»£c láº¥y máº¥u á»Ÿ output (vÃ¬ <code class="language-plaintext highlighter-rouge">M_AXIS_TREADY = '0'</code>). Tuy nhiÃªn, dá»¯ liá»‡u káº¿ tiáº¿p tá»« input váº«n Ä‘Æ°á»£c chuyá»ƒn tiáº¿p vÃ o <code class="language-plaintext highlighter-rouge">register</code> vÃ  ghi Ä‘Ã¨ vÃ o giÃ¡ trá»‹ chÆ°a Ä‘Æ°á»£c láº¥y máº«u á»Ÿ trÃªn. Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» trÃªn, kiáº¿n trÃºc nÃ y sá»­ dá»¥ng thÃªm má»™t lá»›p <code class="language-plaintext highlighter-rouge">expansion registers</code> Ä‘á»ƒ lÆ°u trá»¯ giÃ¡ trá»‹ chÆ°a Ä‘Æ°á»£c láº¥y máº«u khi <code class="language-plaintext highlighter-rouge">M_AXIS_TREADY = '0'</code>, dá»¯ liá»‡u input káº¿ tiáº¿p sáº½ váº«n tiáº¿p tá»¥c lÆ°u trá»¯ vÃ o lá»›p <code class="language-plaintext highlighter-rouge">primary registers</code> nhÆ° cÅ©.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>always_ff @(posedge clk) 
begin
    if (s_axis_tready == 1'b1) begin
        primary_data_reg        &lt;= s_axis_tdata;
        primary_valid_reg       &lt;= s_axis_tvalid;
        if (m_axis_tready == 1'b0) begin
            expansion_data_reg  &lt;= primary_data_reg;
            expansion_valid_reg &lt;= primary_valid_reg;
        end
    end
end
</code></pre></div></div>

<p>Táº¡i chu ká»³ <code class="language-plaintext highlighter-rouge">M_AXIS_TREADY = '1'</code>, lÃºc nÃ y <code class="language-plaintext highlighter-rouge">S_AXIS_TREADY = '0'</code> do cháº­m 1 chu ká»³, dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c <code class="language-plaintext highlighter-rouge">consumer</code> láº¥y tá»« lá»›p <code class="language-plaintext highlighter-rouge">expansion registers</code> trÆ°á»›c, sau Ä‘Ã³ lÃ  tá»« lá»›p <code class="language-plaintext highlighter-rouge">primary registers</code>.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/4-480.webp" />
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/4-800.webp" />
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/01.blogs/230913_pipeline_axi_bus/4-1400.webp" />
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/01.blogs/230913_pipeline_axi_bus/4.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" />

  </picture>

</figure>

    </div>
</div>

<h3 id="c-thiáº¿t-káº¿-rtl">c. Thiáº¿t káº¿ RTL</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>logic [WIDTH-1:0]   expansion_data_reg;
logic               expansion_valid_reg;
logic [WIDTH-1:0]   primary_data_reg;
logic               primary_valid_reg;

always_ff @(posedge clk) 
begin
    if (s_axis_tready == 1'b1) begin
        primary_data_reg        &lt;= s_axis_tdata;
        primary_valid_reg       &lt;= s_axis_tvalid;
        if (m_axis_tready == 1'b0) begin
            expansion_data_reg  &lt;= primary_data_reg;
            expansion_valid_reg &lt;= primary_valid_reg;
        end
    end
    if (m_axis_tready == 1'b1) begin
        expansion_valid_reg     &lt;= 1'b0;
    end
end

assign s_axis_tready = !(expansion_valid_reg); 
assign m_axis_tvalid = (expansion_valid_reg) ? 
                            expansion_valid_reg : 
                            primary_valid_reg;
assign m_axis_tdata  = (expansion_valid_reg) ? 
                            expansion_data_reg : 
                            primary_data_reg;
</code></pre></div></div>

<p>Thiáº¿t káº¿ Ä‘Æ°á»£c viáº¿t báº±ng <code class="language-plaintext highlighter-rouge">SystemVerilog</code> vÃ  Ä‘Æ°á»£c mÃ´ táº£ cá»¥ thá»ƒ á»Ÿ <a href="https://github.com/nguyencanhtrung/systemverilog_axis/blob/master/rtl/axis_reg.sv"><code class="language-plaintext highlighter-rouge">axis_reg.sv</code></a></p>
:ET